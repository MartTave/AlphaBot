from time import sleep

from spade import agent, behaviour
from spade.message import Message

from math import radians
from urbasic import Joint6D, ISCoin

points_trajs = [
    [
		Joint6D([0.10757160186767578, -0.9509723347476502, 0.5184224287616175, -1.1408513647368927, -1.559786621724264, 0.1288362741470337]),
    	Joint6D([0.10794331133365631, -1.0447960656932374, 1.0412586371051233, -1.569802032001764, -1.5600641409503382, 0.13230133056640625]),
    ],
	[
		Joint6D([2.4038941860198975, -1.033994809990265, 0.6758573690997522, -1.2152012151530762, -1.5600264708148401, -0.6885278860675257]),
    	Joint6D([2.4041192531585693, -1.094434605245926, 1.1429360548602503, -1.6218353710570277, -1.560371224080221, -0.6853297392474573]),
    ],
	[
		Joint6D([0.42534419894218445, -1.1330920618823548, 0.8246362845050257, -1.2649039787105103, -1.5603116194354456, -1.0983522574054163]),
    	Joint6D([0.4253786504268646, -1.1736126703074952, 1.2521026770221155, -1.6517869434752406, -1.560721222554342, -1.0954301992999476]),
    ],
	[	
		Joint6D([0.7491384744644165, -1.6952420673766078, 1.5879266897784632, -1.4661291253617783, -1.563044850026266, -0.8003738562213343]),
    	Joint6D([0.748395562171936, -1.6835648022093714, 1.873716179524557, -1.763498922387594, -1.5634854475604456, -0.7989152113543909]),
    ],
	[	
		Joint6D([1.4159247875213623, -1.7160760364928187, 1.5756014029132288, -1.43291728318248, -1.5631287733661097, -0.15351754823793584]),
    	Joint6D([1.415165901184082, -1.712520261804098, 1.8735902945147913, -1.7344542942442835, -1.5635030905352991, -0.15204126039613897]),
    ],
	[
		Joint6D([2.044929265975952, -1.1967132848552247, 0.9916642347918909, -1.368233711724617, -1.5605934301959437, 0.4631415009498596]),
    	Joint6D([2.0448522567749023, -1.2117978793433686, 1.2974556128131312, -1.6589986286559046, -1.5608914534198206, 0.4653005599975586]),
    ],
	[
		Joint6D([0.7474848628044128, -1.0814436239055176, 0.7987402121173304, -1.2919274133494874, -1.5600011984454554, 0.7681112885475159]),
    	Joint6D([0.7475672364234924, -1.1187793177417298, 1.1423004309283655, -1.5982238254942835, -1.560298267995016, 0.7705202698707581]),
    ],
	[
		Joint6D([1.1897848844528198, -1.3378994029811402, 1.1848748365985315, -1.4203604471734543, -1.561244312916891, 1.2292510271072388]),
    	Joint6D([1.1895737648010254, -1.339275987153389, 1.4727509657489222, -1.7068683109679164, -1.5616911093341272, 1.2311956882476807]),
    ],
	[
		Joint6D([1.7264840602874756, -1.0969048005393525, 0.7694209257708948, -1.2467313569835206, -1.5601585547076624, 1.7192895412445068]),
    	Joint6D([1.7266367673873901, -1.1460846227458497, 1.188472096120016, -1.616608282128805, -1.5604704062091272, 1.7221143245697021]),
    ],
	[
		Joint6D([1.0627985000610352, -0.7929492157748719, 0.4352009932147425, -1.2154801052859803, -1.5590832869159144, -0.4939196745501917]),
    	Joint6D([1.0630865097045898, -0.8526634734920044, 0.6946347395526331, -1.4153570097735901, -1.5591424147235315, -0.49224931398500615]),
    ],
	[	
		Joint6D([1.4779607057571411, -0.8010798257640381, 0.2885850111590784, -1.0607992571643372, -1.5593445936786097, -0.1310065428363245]),
    	Joint6D([1.4785782098770142, -0.9436372679523011, 0.8849027792560022, -1.514521674518921, -1.5595768133746546, -0.12731534639467412]),
	]
]   

dispose_wall_traj = [	
	Joint6D([1.4784549474716187, -1.3692631733468552, 0.804641071950094, -2.472374578515524, -1.5511234442340296, -0.009968582783834279]),
    Joint6D([-0.5285533110248011, -1.9816156826415003, 0.5763776938067835, -1.1138972801021119, -1.410884205495016, -1.82335073152651]),
    Joint6D([-0.5285447279559534, -1.9231578312315882, 1.5395382086383265, -1.1340871912292023, -1.5176118055926722, -2.0354960600482386])
]

class RobotArmAgent(agent.Agent):
    def __init__(self, jid, password):
        super().__init__(jid, password)
        self.iscoin = ISCoin(host="10.30.5.158")
        self.iscoin.gripper.activate()


    class MoveWallBehaviour(behaviour.OneShotBehaviour):
        def __init__(self, id):
            super().__init__()
            self.id = id

        def move_robot(self, joint_pos):
            #self.agent.iscoin.robot_control.movej(joint_pos, a = radians(80), v = radians(30))
            print(f"ahah I moved to {joint_pos}")
            sleep(0.1)

        async def run(self):
            self.agent.processing_complete.clear()

            # from home position to ready to grab position
            for i in range(2,-1,-1):
                sleep(0.05)
                self.agent.iscoin.robot_control.movej(dispose_wall_traj[i], a = radians(80), v = radians(30))
                sleep(0.05)
                
            # gets the wall
            self.move_robot(points_trajs[i][0])
            #self.agent.iscoin.gripper.open()
            self.move_robot(points_trajs[i][1])
            #self.agent.iscoin.gripper.close()
            self.move_robot(points_trajs[i][0])

            # from grab position to home position
            for i in range(3):
                self.move_robot(dispose_wall_traj[i])

            self.agent.iscoin.gripper.open()

            self.agent.processing_complete.set()


    class WaitForRequestBehaviour(behaviour.CyclicBehaviour):
        def __init__(self):
            super().__init__()

        async def run(self):
            print("Waiting for request...")
            msg = await self.receive(timeout=9999)
            if msg:
                print("Received wall removal request.")
                id = str(msg.body)
                self.agent.add_behaviour(
                    self.agent.MoveWallBehaviour(id=id)
                )


    async def setup(self):        
        print("robot arm is ready.")

        # Keep the XMPP behaviors for wall removal
        self.add_behaviour(self.WaitForRequestBehaviour())

    async def stop(self):
        # Then stop the agent
        self.iscoin.gripper.deactivate()
        await super().stop()
